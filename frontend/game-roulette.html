<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SO2 Casino ‚Äî –†—É–ª–µ—Ç–∫–∞</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { padding-top: 60px; }

    /* ‚îÄ‚îÄ WHEEL ‚îÄ‚îÄ */
    .roulette-scene {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 0 16px;
      position: relative;
    }
    .wheel-pointer {
      width: 0; height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 22px solid var(--gold-primary);
      filter: drop-shadow(0 0 6px rgba(255,202,145,0.7));
      margin-bottom: -4px;
      z-index: 2;
      position: relative;
    }
    .wheel-outer {
      width: 240px; height: 240px;
      border-radius: 50%;
      border: 4px solid var(--gold-dark);
      box-shadow: var(--glow-gold), inset 0 0 30px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
      transition: transform 0s;
    }
    .wheel-outer.spinning {
      transition: transform 4s cubic-bezier(.17,.67,.12,.99);
    }
    .wheel-canvas {
      width: 100%; height: 100%;
      border-radius: 50%;
    }
    .wheel-center {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 44px; height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-dark), var(--gold-deep));
      border: 3px solid var(--gold-primary);
      box-shadow: var(--glow-gold);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem;
      z-index: 3;
    }

    /* ‚îÄ‚îÄ RESULT STRIP ‚îÄ‚îÄ */
    .result-strip {
      display: flex;
      gap: 6px;
      margin: 16px 0;
      overflow-x: auto;
      padding-bottom: 4px;
      min-height: 34px;
    }
    .rs-ball {
      width: 30px; height: 30px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-head);
      font-size: .65rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .rs-red   { background: #8b1a1a; border: 1px solid #cc2222; color: #ffaaaa; }
    .rs-black { background: #1a1a1a; border: 1px solid #444;    color: #ccc; }
    .rs-green { background: #1a4a1a; border: 1px solid #2e8b2e; color: #88ff88; }

    /* ‚îÄ‚îÄ BET TABLE ‚îÄ‚îÄ */
    .bet-table {
      display: grid;
      gap: 6px;
      margin-bottom: 16px;
    }
    .bet-table-row {
      display: flex;
      gap: 6px;
    }
    .bet-cell {
      flex: 1;
      padding: 10px 6px;
      border-radius: var(--radius-sm);
      border: 1.5px solid rgba(165,118,36,0.2);
      font-family: var(--font-head);
      font-size: .65rem;
      letter-spacing: .08em;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      user-select: none;
    }
    .bet-cell:hover { border-color: rgba(165,118,36,0.6); filter: brightness(1.2); }
    .bet-cell.has-bet { border-color: var(--gold-primary); box-shadow: var(--glow-gold); }
    .bet-cell .chip-on {
      position: absolute;
      top: -8px; right: -8px;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--gold-dark);
      border: 1px solid var(--gold-primary);
      font-size: .55rem;
      display: flex; align-items: center; justify-content: center;
      color: var(--gold-primary);
      font-family: var(--font-head);
    }

    .bc-red   { background: rgba(139,26,26,0.35); color: #ff8888; }
    .bc-black { background: rgba(30,30,30,0.6);   color: #cccccc; }
    .bc-green { background: rgba(26,74,26,0.5);   color: #88ff88; }
    .bc-gold  { background: rgba(165,118,36,0.15); color: var(--gold-primary); }

    /* number grid */
    .num-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }
    .num-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-head);
      font-size: .58rem;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      transition: var(--transition);
      user-select: none;
    }
    .num-cell:hover { transform: scale(1.15); border-color: var(--gold-primary); }
    .num-cell.selected { border-color: var(--gold-primary); box-shadow: 0 0 8px rgba(255,202,145,0.5); transform: scale(1.1); }
    .nc-red   { background: rgba(139,26,26,0.5); color: #ffaaaa; }
    .nc-black { background: rgba(20,20,20,0.8);  color: #cccccc; }
    .nc-green { background: rgba(26,74,26,0.7);  color: #88ff88; }

    /* chip selector */
    .chip-selector {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .chip {
      width: 48px; height: 48px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--font-head);
      font-size: .65rem;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid rgba(165,118,36,0.3);
      background: linear-gradient(135deg, var(--gold-deep), var(--gold-darker));
      color: var(--gold-primary);
      transition: var(--transition);
      user-select: none;
    }
    .chip:hover  { transform: scale(1.1); border-color: var(--gold-primary); }
    .chip.active { border-color: var(--gold-primary); box-shadow: var(--glow-gold); transform: scale(1.12); }

    .total-bet-display {
      text-align: center;
      font-family: var(--font-head);
      font-size: .72rem;
      color: var(--text-muted);
      letter-spacing: .1em;
      margin-bottom: 12px;
    }
    .total-bet-display span { color: var(--gold-primary); font-size: .9rem; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="navbar-logo">
      <span>üéØ</span>
      <div class="logo-text">SO2 CASINO<span class="so2-tag">STANDOFF 2</span></div>
    </div>
    <ul class="navbar-nav">
      <li><a href="lobby.html">üéÆ –ò–≥—Ä—ã</a></li>
    </ul>
    <div class="navbar-right">
      <div class="wallet-chip"><span class="w-icon">ü•á</span><span class="w-amount" id="nav-balance">‚Äî</span></div>
      <div class="avatar">üë§</div>
    </div>
  </nav>

  <main class="game-wrap">
    <button class="back-btn" onclick="window.location.href='lobby.html'">‚Üê –ù–∞–∑–∞–¥ –≤ –ª–æ–±–±–∏</button>

    <div class="game-panel">
      <div class="section-title">üé∞ –†—É–ª–µ—Ç–∫–∞</div>

      <!-- Wheel -->
      <div class="roulette-scene">
        <div class="wheel-pointer"></div>
        <div class="wheel-outer" id="wheel-outer">
          <canvas class="wheel-canvas" id="wheel-canvas" width="240" height="240"></canvas>
          <div class="wheel-center">üéØ</div>
        </div>
      </div>

      <!-- History strip -->
      <div class="result-strip" id="result-strip">
        <div style="color:var(--text-muted);font-size:.75rem;padding:6px">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –±—Ä–æ—Å–∫–∞</div>
      </div>

      <div class="divider"></div>

      <!-- Chip selector -->
      <div style="font-family:var(--font-head);font-size:.65rem;letter-spacing:.12em;color:var(--text-muted);text-align:center;margin-bottom:10px;text-transform:uppercase">–í—ã–±–µ—Ä–∏ —Ñ–∏—à–∫—É</div>
      <div class="chip-selector">
        <div class="chip active" data-val="10"   onclick="selectChip(this,10)">10</div>
        <div class="chip"        data-val="50"   onclick="selectChip(this,50)">50</div>
        <div class="chip"        data-val="100"  onclick="selectChip(this,100)">100</div>
        <div class="chip"        data-val="250"  onclick="selectChip(this,250)">250</div>
        <div class="chip"        data-val="500"  onclick="selectChip(this,500)">500</div>
      </div>

      <!-- Number grid -->
      <div style="font-family:var(--font-head);font-size:.65rem;letter-spacing:.12em;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase">–ß–∏—Å–ª–∞ (1‚Äì36 + 0)</div>
      <div class="num-grid" id="num-grid"></div>

      <!-- Bet categories -->
      <div class="bet-table">
        <div class="bet-table-row">
          <div class="bet-cell bc-red"   id="bc-red"   onclick="toggleCatBet('red')">üî¥ –ö—Ä–∞—Å–Ω–æ–µ<br/><small style="color:var(--text-muted)">x2</small></div>
          <div class="bet-cell bc-black" id="bc-black" onclick="toggleCatBet('black')">‚ö´ –ß—ë—Ä–Ω–æ–µ<br/><small style="color:var(--text-muted)">x2</small></div>
          <div class="bet-cell bc-green" id="bc-green" onclick="toggleCatBet('green')">üü¢ –ó–µ—Ä–æ<br/><small style="color:var(--text-muted)">x14</small></div>
        </div>
        <div class="bet-table-row">
          <div class="bet-cell bc-gold" id="bc-odd"  onclick="toggleCatBet('odd')">–ù–µ—á—ë—Ç–Ω–æ–µ<br/><small style="color:var(--text-muted)">x2</small></div>
          <div class="bet-cell bc-gold" id="bc-even" onclick="toggleCatBet('even')">–ß—ë—Ç–Ω–æ–µ<br/><small style="color:var(--text-muted)">x2</small></div>
          <div class="bet-cell bc-gold" id="bc-half1" onclick="toggleCatBet('half1')">1‚Äì18<br/><small style="color:var(--text-muted)">x2</small></div>
          <div class="bet-cell bc-gold" id="bc-half2" onclick="toggleCatBet('half2')">19‚Äì36<br/><small style="color:var(--text-muted)">x2</small></div>
        </div>
      </div>

      <!-- Total bet & controls -->
      <div class="total-bet-display">–°—Ç–∞–≤–∫–∞: <span id="total-bet-display">0</span> ü•á</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button class="btn btn-outline" onclick="clearBets()">üóë –°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="btn btn-gold" id="spin-btn" onclick="spinRoulette()" style="padding:13px">üé∞ –ö—Ä—É—Ç–∏—Ç—å</button>
      </div>

      <div class="result-box result-wait" id="result-box" style="margin-top:20px">
        –°–¥–µ–ª–∞–π —Å—Ç–∞–≤–∫—É –∏ –∫—Ä—É—Ç–∏
      </div>
    </div>
  </main>

  <script>
    const API    = window.SO2_API || 'https://your-backend.com/api';
    const tg     = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }
    const userId = tg?.initDataUnsafe?.user?.id || localStorage.getItem('so2_uid') || 'guest';

    function getHeaders() {
      const h = { 'Content-Type': 'application/json', 'X-User-Id': String(userId) };
      if (tg?.initData) h['X-Tg-Init-Data'] = tg.initData;
      return h;
    }

    async function loadBalance() {
      try {
        const r = await fetch(API + '/user/balance', { headers: getHeaders() });
        const d = await r.json();
        document.getElementById('nav-balance').textContent = d.gold.toLocaleString() + ' ü•á';
      } catch { document.getElementById('nav-balance').textContent = '‚Äî ü•á'; }
    }
    loadBalance();

    // ‚îÄ‚îÄ Wheel draw ‚îÄ‚îÄ
    const RED_NUMS   = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
    const WHEEL_NUMS = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];

    const canvas = document.getElementById('wheel-canvas');
    const ctx    = canvas.getContext('2d');
    const SEG    = (Math.PI * 2) / WHEEL_NUMS.length;

    function drawWheel(rotOffset = 0) {
      const cx = canvas.width / 2, cy = canvas.height / 2, r = cx - 2;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      WHEEL_NUMS.forEach((num, i) => {
        const start = rotOffset + i * SEG - Math.PI / 2;
        const end   = start + SEG;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, end);
        ctx.closePath();
        const color = num === 0 ? '#1a4a1a' : RED_NUMS.includes(num) ? '#6b1111' : '#111';
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = 'rgba(165,118,36,0.3)';
        ctx.lineWidth = 1;
        ctx.stroke();
        // Label
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(start + SEG / 2);
        ctx.textAlign = 'right';
        ctx.fillStyle = num === 0 ? '#88ff88' : RED_NUMS.includes(num) ? '#ffaaaa' : '#ccc';
        ctx.font = 'bold 9px Orbitron, sans-serif';
        ctx.fillText(String(num), r - 6, 4);
        ctx.restore();
      });
    }
    drawWheel();

    // ‚îÄ‚îÄ Number grid ‚îÄ‚îÄ
    const numGrid = document.getElementById('num-grid');
    // 0 first
    const zeroCell = document.createElement('div');
    zeroCell.className = 'num-cell nc-green';
    zeroCell.textContent = '0';
    zeroCell.onclick = () => toggleNumBet(0, zeroCell);
    numGrid.appendChild(zeroCell);

    for (let i = 1; i <= 36; i++) {
      const cell = document.createElement('div');
      cell.className = 'num-cell ' + (RED_NUMS.includes(i) ? 'nc-red' : 'nc-black');
      cell.textContent = i;
      cell.onclick = () => toggleNumBet(i, cell);
      numGrid.appendChild(cell);
    }

    // ‚îÄ‚îÄ Bet state ‚îÄ‚îÄ
    let selectedChip = 10;
    let bets = {}; // { 'num_7': 50, 'cat_red': 100, ... }

    function selectChip(el, val) {
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      el.classList.add('active');
      selectedChip = val;
    }

    function toggleNumBet(num, cell) {
      const key = 'num_' + num;
      bets[key] = (bets[key] || 0) + selectedChip;
      cell.classList.add('selected');
      updateTotalBet();
    }

    function toggleCatBet(cat) {
      const key = 'cat_' + cat;
      bets[key] = (bets[key] || 0) + selectedChip;
      const el = document.getElementById('bc-' + cat);
      if (el) {
        el.classList.add('has-bet');
        let chip = el.querySelector('.chip-on');
        if (!chip) { chip = document.createElement('div'); chip.className = 'chip-on'; el.appendChild(chip); }
        chip.textContent = bets[key];
      }
      updateTotalBet();
    }

    function updateTotalBet() {
      const total = Object.values(bets).reduce((a,b) => a+b, 0);
      document.getElementById('total-bet-display').textContent = total.toLocaleString();
    }

    function clearBets() {
      bets = {};
      document.querySelectorAll('.num-cell').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.bet-cell').forEach(c => { c.classList.remove('has-bet'); const ch = c.querySelector('.chip-on'); if(ch) ch.remove(); });
      updateTotalBet();
    }

    // ‚îÄ‚îÄ Spin ‚îÄ‚îÄ
    let isSpinning = false;
    const history  = [];

    async function spinRoulette() {
      if (isSpinning) return;
      const total = Object.values(bets).reduce((a,b) => a+b, 0);
      if (total < 10) { showToast('‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 10 ü•á'); return; }

      isSpinning = true;
      const btn = document.getElementById('spin-btn');
      btn.disabled = true;

      const resultBox = document.getElementById('result-box');
      resultBox.className = 'result-box result-wait';
      resultBox.textContent = 'üé∞ –ö—Ä—É—Ç–∏–º...';

      // Animate wheel spinning
      const wheelEl = document.getElementById('wheel-outer');
      const spinDeg = 1440 + Math.floor(Math.random() * 360);
      wheelEl.style.transition = 'transform 4s cubic-bezier(.17,.67,.12,.99)';
      wheelEl.style.transform  = `rotate(${spinDeg}deg)`;

      try {
        const r = await fetch(API + '/games/roulette/play', {
          method:  'POST',
          headers: getHeaders(),
          body:    JSON.stringify({ bets })
        });
        if (!r.ok) throw new Error(await r.text());
        const d = await r.json();

        // Wait for spin animation (4s)
        await new Promise(res => setTimeout(res, 4100));

        // d.number ‚Äî winning number from backend
        // d.won    ‚Äî bool
        // d.payout ‚Äî gold won
        const num   = d.number;
        const color = num === 0 ? 'green' : RED_NUMS.includes(num) ? 'red' : 'black';

        // Show result
        if (d.won) {
          resultBox.className = 'result-box result-win';
          resultBox.textContent = `–í—ã–ø–∞–ª–æ ${num} ¬∑ +${(d.payout||0).toLocaleString()} ü•á –ü–û–ë–ï–î–ê!`;
        } else {
          resultBox.className = 'result-box result-lose';
          resultBox.textContent = `–í—ã–ø–∞–ª–æ ${num} ¬∑ -${total.toLocaleString()} ü•á`;
        }

        // History strip
        history.unshift({ num, color });
        if (history.length > 18) history.pop();
        renderHistory();
        loadBalance();

        // Reset wheel visual
        setTimeout(() => {
          wheelEl.style.transition = 'none';
          wheelEl.style.transform  = 'rotate(0deg)';
        }, 500);

      } catch (e) {
        resultBox.className = 'result-box result-lose';
        resultBox.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }

      clearBets();
      btn.disabled = false;
      isSpinning   = false;
    }

    function renderHistory() {
      document.getElementById('result-strip').innerHTML = history.map(h => `
        <div class="rs-ball rs-${h.color}">${h.num}</div>
      `).join('');
    }

    function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast'; t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 2700);
    }
  </script>
</body>
</html>
