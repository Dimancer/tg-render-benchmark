<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>SO2 CRASH</title>
    <style>
        :root {
            --gold: #ffb400;
            --dark: #0a0a0a;
            --card: #151515;
            --red: #ff3e3e;
            --green: #00ff7f;
        }

        body {
            background: var(--dark);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            border-bottom: 1px solid #222;
        }

        .balance-box {
            background: rgba(255, 180, 0, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid var(--gold);
            color: var(--gold);
            font-weight: bold;
        }

        /* Зона краша */
        .game-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #multiplier {
            font-size: 80px;
            font-weight: 900;
            transition: transform 0.1s;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }

        .crushed {
            color: var(--red) !important;
            animation: shake 0.4s;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-1deg); }
            40% { transform: translate(3px, 2px) rotate(1deg); }
            60% { transform: translate(-1px, -1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Кнопки и ввод */
        .controls {
            background: var(--card);
            padding: 25px;
            border-radius: 30px 30px 0 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input {
            flex-grow: 1;
            background: #222;
            border: 1px solid #333;
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 18px;
            outline: none;
        }

        .main-btn {
            padding: 20px;
            border-radius: 15px;
            border: none;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-start { background: var(--gold); color: black; }
        .btn-cashout { background: var(--green); color: black; box-shadow: 0 0 20px rgba(0, 255, 127, 0.4); }
        .btn-disabled { background: #333; color: #777; pointer-events: none; }

        .history {
            display: flex;
            gap: 8px;
            padding: 10px;
            overflow-x: auto;
            font-size: 12px;
        }

        .history-item {
            padding: 2px 8px;
            border-radius: 4px;
            background: #222;
        }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight: bold;">GOLD CRASH</div>
        <div class="balance-box" id="balance">0 G</div>
    </div>

    <div class="history" id="history"></div>

    <div class="game-area">
        <div id="multiplier">1.00x</div>
        <div id="status-text" style="margin-top: 10px; color: #555;">Ожидание ставки...</div>
    </div>

    <div class="controls">
        <div class="input-group">
            <input type="number" id="betAmount" value="100" placeholder="Сумма ставки">
        </div>
        <button id="actionBtn" class="main-btn btn-start" onclick="handleAction()">ПОСТАВИТЬ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let balance = 0;
        let currentMultiplier = 1.00;
        let isRunning = false;
        let gameInterval;
        let betValue = 0;

        const multDisplay = document.getElementById('multiplier');
        const actionBtn = document.getElementById('actionBtn');
        const balanceDisplay = document.getElementById('balance');

        async function init() {
            const user = tg.initDataUnsafe.user;
            const res = await fetch(`/api/get_user?user_id=${user.id}&name=${user.first_name}`);
            const data = await res.json();
            balance = data.balance;
            updateUI();
        }

        function updateUI() {
            balanceDisplay.innerText = balance + " G";
        }

        function handleAction() {
            if (!isRunning) {
                startGame();
            } else {
                cashOut();
            }
        }

        function startGame() {
            const input = document.getElementById('betAmount');
            betValue = parseInt(input.value);

            if (betValue > balance || betValue <= 0) {
                tg.showAlert("Недостаточно Gold!");
                return;
            }

            // Сбрасываем состояние
            isRunning = true;
            currentMultiplier = 1.00;
            multDisplay.classList.remove('crushed');
            multDisplay.style.color = 'white';
            
            actionBtn.innerText = "ЗАБРАТЬ";
            actionBtn.className = "main-btn btn-cashout";
            document.getElementById('status-text').innerText = "Ракета летит!";

            // Анимация роста
            gameInterval = setInterval(() => {
                currentMultiplier += 0.01 + (currentMultiplier * 0.005);
                multDisplay.innerText = currentMultiplier.toFixed(2) + "x";
                
                // Случайный визуальный краш (только для фронтенда, проверка на бэке)
                if (Math.random() < 0.005 && currentMultiplier > 2.0) {
                    // Это просто для теста, реальный краш проверит сервер
                }
            }, 100);
        }

        async function cashOut() {
            stopGame();
            const user = tg.initDataUnsafe.user;
            
            const res = await fetch(`/api/crash_result?user_id=${user.id}&bet=${betValue}&cashout_multiplier=${currentMultiplier.toFixed(2)}`);
            const data = await res.json();

            if (data.success) {
                balance = data.new_balance;
                multDisplay.style.color = 'var(--green)';
                tg.HapticFeedback.notificationOccurred('success');
                showHistory(currentMultiplier.toFixed(2), true);
            } else {
                crashEffect(data.crash_point);
            }
            updateUI();
        }

        function stopGame() {
            clearInterval(gameInterval);
            isRunning = false;
            actionBtn.innerText = "ПОСТАВИТЬ";
            actionBtn.className = "main-btn btn-start";
        }

        function crashEffect(point) {
            stopGame();
            balance -= betValue; // Условно, сервер уже вычел
            multDisplay.innerText = point.toFixed(2) + "x";
            multDisplay.classList.add('crushed');
            document.getElementById('status-text').innerText = "CRASHED!";
            tg.HapticFeedback.notificationOccurred('error');
            showHistory(point.toFixed(2), false);
        }

        function showHistory(val, win) {
            const hist = document.getElementById('history');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.color = win ? 'var(--green)' : 'var(--red)';
            item.innerText = val + 'x';
            hist.prepend(item);
        }

        init();
    </script>
</body>
</html>