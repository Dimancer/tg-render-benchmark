<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffb400; --bg: #0f0f0f; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        #gameCanvas { width: 100%; height: 300px; background: #151515; }
        .controls { padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .main-btn { padding: 18px; border-radius: 12px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; }
        .btn-bet { background: var(--gold); color: black; }
        .btn-cash { background: #00ff7f; color: black; }
        input { background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; text-align: center; }
        #mult { position: absolute; width: 100%; text-align: center; top: 150px; font-size: 48px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>
    <div class="header">
        <span style="color: var(--gold); font-weight: bold;">STAY GOLD</span>
        <span id="balance">Загрузка...</span>
    </div>

    <div style="position: relative;">
        <canvas id="gameCanvas"></canvas>
        <div id="mult">1.00x</div>
    </div>

    <div class="controls">
        <input type="number" id="betInput" value="100">
        <button id="actionBtn" class="main-btn btn-bet" onclick="handleAction()">СТАВКА</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const multText = document.getElementById('mult');
        
        let balance = 0;
        let isRunning = false;
        let startTime = 0;
        let currentMult = 1.00;
        let animationId;

        // Настройка канваса под экран
        canvas.width = window.innerWidth;
        canvas.height = 300;

        async function loadUser() {
            const user = tg.initDataUnsafe.user;
            const res = await fetch(`/api/get_user?user_id=${user.id}&name=${user.first_name}`);
            const data = await res.json();
            balance = data.balance;
            document.getElementById('balance').innerText = balance + " G";
        }

        async function handleAction() {
            const user = tg.initDataUnsafe.user;
            const btn = document.getElementById('actionBtn');

            if (!isRunning) {
                const bet = document.getElementById('betInput').value;
                const res = await fetch(`/api/place_bet?user_id=${user.id}&bet=${bet}`, {method: 'POST'});
                if (!res.ok) return alert("Ошибка!");
                
                const data = await res.json();
                balance = data.new_balance;
                document.getElementById('balance').innerText = balance + " G";

                startAnimation();
                btn.innerText = "ЗАБРАТЬ";
                btn.className = "main-btn btn-cash";
            } else {
                const res = await fetch(`/api/cashout?user_id=${user.id}&current_multiplier=${currentMult.toFixed(2)}`, {method: 'POST'});
                const data = await res.json();
                
                stopAnimation();
                if (data.status === "win") {
                    balance = data.new_balance;
                    tg.HapticFeedback.notificationOccurred('success');
                    multText.style.color = "#00ff7f";
                } else {
                    crash(data.crash_point);
                }
                document.getElementById('balance').innerText = balance + " G";
                btn.innerText = "СТАВКА";
                btn.className = "main-btn btn-bet";
            }
        }

        function startAnimation() {
            isRunning = true;
            startTime = Date.now();
            currentMult = 1.00;
            multText.style.color = "white";
            animate();
        }

        function animate() {
            if (!isRunning) return;

            const elapsed = (Date.now() - startTime) / 1000;
            currentMult = Math.pow(1.15, elapsed * 2); // Плавный рост
            multText.innerText = currentMult.toFixed(2) + "x";

            // Рисуем график
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = '#ffb400';
            ctx.lineWidth = 4;
            ctx.moveTo(0, canvas.height);

            for (let x = 0; x < canvas.width; x++) {
                let t = (x / canvas.width) * elapsed;
                let y = canvas.height - (Math.pow(1.15, t * 2) * 20);
                if (x / canvas.width > 1) break;
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Рисуем "ракету" (желтый круг)
            let headX = Math.min(elapsed * 50, canvas.width - 20);
            let headY = canvas.height - (currentMult * 20);
            ctx.fillStyle = '#ffb400';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#ffb400';
            ctx.beginPath();
            ctx.arc(headX, headY, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            animationId = requestAnimationFrame(animate);
        }

        function stopAnimation() {
            isRunning = false;
            cancelAnimationFrame(animationId);
        }

        function crash(point) {
            stopAnimation();
            multText.innerText = point.toFixed(2) + "x";
            multText.style.color = "#ff3e3e";
            tg.HapticFeedback.notificationOccurred('error');
        }

        loadUser();
    </script>
</body>
</html>